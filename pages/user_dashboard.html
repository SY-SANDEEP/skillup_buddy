<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - SkillUp Buddy</title>
    
    <link rel="stylesheet" href="../css/main.css" />
</head>
<body class="bg-background min-h-screen">
    <!-- Header -->
    <header class="bg-surface shadow-sm border-b border-border">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="../index.html" class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.84L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.84l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"/>
                            </svg>
                        </div>
                        <span class="text-xl font-semibold text-text-primary">SkillUp Buddy</span>
                    </a>
                </div>

                <nav class="hidden md:flex items-center space-x-8">
                    <a href="user_dashboard.html" class="text-primary font-medium">Dashboard</a>
                    <a href="interactive_skills_quiz.html" class="text-text-secondary hover:text-primary transition-colors">Take Quiz</a>
                    <a href="course_recommendations_dashboard.html" class="text-text-secondary hover:text-primary transition-colors">Recommendations</a>
                </nav>

                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button id="userMenuBtn" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-50">
                            <img id="userAvatar" src="" alt="Avatar" class="w-8 h-8 rounded-full object-cover hidden" />
                            <span id="userInitials" class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center text-primary font-semibold text-sm"></span>
                            <span id="userName" class="hidden md:block text-text-primary font-medium"></span>
                            <svg class="w-4 h-4 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div id="userDropdown" class="absolute right-0 mt-2 w-48 bg-surface rounded-lg shadow-lg border border-border hidden z-50">
                            <div class="py-1">
                                <a href="user_profile_management.html" class="block px-4 py-2 text-sm text-text-primary hover:bg-gray-50">Profile Settings</a>
                                <a href="course_recommendations_dashboard.html" class="block px-4 py-2 text-sm text-text-primary hover:bg-gray-50">My Courses</a>
                                <div class="border-t border-border"></div>
                                <button onclick="handleLogout()" class="block w-full text-left px-4 py-2 text-sm text-text-primary hover:bg-gray-50">Sign Out</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Welcome Section -->
         <!-- Add this where you show user info -->
<div class="pro-status-banner" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1rem; border-radius: 0.5rem; color: white; margin-bottom: 1rem;">
    <div style="display: flex; align-items: center; justify-content: space-between;">
        <div>
            <h3 style="margin: 0; font-size: 1.25rem;">‚ú® Pro Member</h3>
            <p style="margin: 0.25rem 0 0 0; opacity: 0.9;">Valid until: <span id="proEndDate"></span></p>
        </div>
        <button onclick="manageSub()" style="background: white; color: #667eea; padding: 0.5rem 1rem; border-radius: 0.375rem; border: none; cursor: pointer; font-weight: 600;">
            Manage
        </button>
    </div>
</div>

<script>
// Show Pro end date
const user = JSON.parse(localStorage.getItem('sb_user') || '{}');
if (user.subscription?.endDate) {
    const endDate = new Date(user.subscription.endDate).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    document.getElementById('proEndDate').textContent = endDate;
}

function manageSub() {
    alert('Subscription management coming soon!\n\nYour Pro membership is active.');
}
</script>


        <section class="mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                <div>
                    <h1 class="text-3xl font-semibold text-text-primary mb-2">Welcome back, <span id="welcomeName"></span>! üëã</h1>
                    <p class="text-text-secondary">Continue your learning journey and discover new skills</p>
                </div>
                <div class="mt-4 sm:mt-0 flex items-center space-x-4">
                    <div class="flex items-center space-x-2 bg-accent-50 px-3 py-2 rounded-lg">
                        <svg class="w-5 h-5 text-accent" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        <span class="text-accent font-medium" id="streakDays">Loading...</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Quick Stats -->
        <section class="mb-8">
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-text-secondary text-sm">Courses Explored</p>
                            <p id="coursesExplored" class="text-2xl font-semibold text-text-primary">0</p>
                        </div>
                        <div class="w-12 h-12 bg-primary-50 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-text-secondary text-sm">Quizzes Completed</p>
                            <p id="quizzesCompleted" class="text-2xl font-semibold text-text-primary">0</p>
                        </div>
                        <div class="w-12 h-12 bg-secondary-50 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-text-secondary text-sm">Learning Hours</p>
                            <p id="learningHours" class="text-2xl font-semibold text-text-primary">0</p>
                        </div>
                        <div class="w-12 h-12 bg-accent-50 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-text-secondary text-sm">Saved Courses</p>
                            <p id="savedCourses" class="text-2xl font-semibold text-text-primary">0</p>
                        </div>
                        <div class="w-12 h-12 bg-warning-50 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Quick Actions -->
        <section class="mb-8">
            <div class="flex flex-col sm:flex-row gap-4">
                <a href="interactive_skills_quiz.html" class="btn btn-primary flex-1">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    Take New Quiz
                </a>
                <a href="course_recommendations_dashboard.html" class="btn btn-secondary flex-1">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    Browse Recommendations
                </a>
            </div>
        </section>

        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Recent Quiz Results -->
                <section>
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold text-text-primary">Your Quiz Results</h2>
                    </div>

                    <div id="quizResultsContainer" class="space-y-4">
                        <div class="card p-6">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <h3 class="font-medium text-text-primary mb-2">Skills Assessment Quiz</h3>
                                    <p class="text-text-secondary text-sm mb-3" id="quizCompletedDate">Completed recently</p>
                                    <div class="flex items-center space-x-4">
                                        <div class="flex items-center space-x-2">
                                            <div class="w-3 h-3 bg-primary rounded-full"></div>
                                            <span class="text-sm text-text-secondary" id="quizSkillLevel">Loading...</span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <div class="w-3 h-3 bg-accent rounded-full"></div>
                                            <span class="text-sm text-text-secondary" id="quizInterests">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <a href="course_recommendations_dashboard.html" class="btn btn-primary text-sm px-3 py-1">
                                        View Courses
                                    </a>
                                    <a href="interactive_skills_quiz.html" class="text-text-secondary hover:text-primary transition-colors">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Bookmarked Courses -->
                <section>
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold text-text-primary">Bookmarked Courses</h2>
                        <a href="course_recommendations_dashboard.html" class="text-primary hover:underline text-sm font-medium">View All</a>
                    </div>

                    <div id="bookmarkedCoursesLoading" class="text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
                    </div>

                    <div id="bookmarkedCoursesContainer" class="grid sm:grid-cols-2 gap-6 hidden"></div>
                    
                    <div id="noBookmarks" class="hidden text-center py-8">
                        <p class="text-text-secondary">No bookmarked courses yet. Start exploring!</p>
                        <a href="course_recommendations_dashboard.html" class="btn btn-primary mt-4">Browse Courses</a>
                    </div>
                </section>
            </div>

            <!-- Sidebar -->
            <div class="space-y-8">
                <!-- Learning Progress -->
                <section>
                    <h2 class="text-xl font-semibold text-text-primary mb-6">Learning Progress</h2>
                    <div class="card p-6">
                        <div class="space-y-6" id="learningProgressContainer">
                            <p class="text-sm text-text-secondary text-center py-4">Complete the quiz to see your progress</p>
                        </div>
                    </div>
                </section>

                <!-- Recent Activity -->
                <section>
                    <h2 class="text-xl font-semibold text-text-primary mb-6">Recent Activity</h2>
                    <div class="card p-6">
                        <div class="space-y-4" id="recentActivityContainer">
                            <div class="flex items-start space-x-3">
                                <div class="w-8 h-8 bg-primary-50 rounded-full flex items-center justify-center flex-shrink-0">
                                    <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm text-text-primary">Created account</p>
                                    <p class="text-xs text-text-secondary" id="accountCreatedDate">Recently</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <footer class="bg-surface border-t border-border mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="text-center text-text-secondary text-sm">
                <p>&copy; 2025 SkillUp Buddy. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Replace the entire <script> section in user_dashboard.html with this enhanced version -->

<script>
    // ‚úÖ FIX: Dynamic API_BASE - works on any PC
    const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
    ? 'http://localhost:5000'
    : 'https://skillup-buddy.onrender.com';

    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Dashboard initializing...');
        
        // Check authentication
        const token = localStorage.getItem('sb_token') || localStorage.getItem('skillupToken');
        if (!token) {
            console.warn('‚ùå No authentication token found');
            window.location.href = 'user_login.html';
            return;
        }
        
        console.log('‚úÖ User authenticated');
        console.log('üìä API Base:', API_BASE);

        // Load all data
        loadUserData();
        loadDashboardStats();
        loadQuizResults();
        loadBookmarkedCourses();
        loadRecentActivity();

        // User menu toggle
        const userMenuBtn = document.getElementById('userMenuBtn');
        const userDropdown = document.getElementById('userDropdown');

        if (userMenuBtn && userDropdown) {
            userMenuBtn.addEventListener('click', function() {
                userDropdown.classList.toggle('hidden');
            });

            document.addEventListener('click', function(e) {
                if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                    userDropdown.classList.add('hidden');
                }
            });
        }
        
        console.log('‚úÖ Dashboard initialized successfully');
    });

    function loadUserData() {
        const user = JSON.parse(localStorage.getItem('sb_user') || localStorage.getItem('skillupUser') || '{}');
        
        if (user.firstName) {
            const fullName = `${user.firstName} ${user.lastName || ''}`.trim();
            const firstName = user.firstName;
            
            document.getElementById('userName').textContent = fullName;
            document.getElementById('welcomeName').textContent = firstName;
            
            // Set initials
            const initials = user.firstName.charAt(0) + (user.lastName ? user.lastName.charAt(0) : '');
            document.getElementById('userInitials').textContent = initials.toUpperCase();
            
            // Set avatar if exists
            if (user.profilePhoto) {
                document.getElementById('userAvatar').src = user.profilePhoto;
                document.getElementById('userAvatar').classList.remove('hidden');
                document.getElementById('userInitials').classList.add('hidden');
            }

            // Account creation date
            if (user.createdAt) {
                const date = new Date(user.createdAt);
                document.getElementById('accountCreatedDate').textContent = formatDate(date);
            }
        }
    }

    async function loadDashboardStats() {
        const token = localStorage.getItem('sb_token') || localStorage.getItem('skillupToken');

        // Step 1: Show local values immediately (fast feedback)
        const localBookmarks = JSON.parse(localStorage.getItem('bookmarkedCourses') || '[]');
        const localQuiz = localStorage.getItem('skillsQuizResults');
        const localUser = JSON.parse(localStorage.getItem('sb_user') || localStorage.getItem('skillupUser') || '{}');

        // Show local quiz count immediately while server loads
        // ‚úÖ Use server-tracked quizzesCompleted from cached user, not hardcoded '1'
        document.getElementById('quizzesCompleted').textContent = localUser.quizzesCompleted || (localQuiz ? '1' : '0');
        document.getElementById('savedCourses').textContent = localBookmarks.length;
        document.getElementById('coursesExplored').textContent = localUser.coursesExplored || localBookmarks.length;
        document.getElementById('learningHours').textContent = localUser.learningHours || (localBookmarks.length * 2);

        // Show streak from local quiz
        if (localQuiz) {
            const quiz = JSON.parse(localQuiz);
            if (quiz.completedAt) {
                document.getElementById('streakDays').textContent = getStreakText(quiz.completedAt);
            }
        } else {
            document.getElementById('streakDays').textContent = 'Take quiz today! üéØ';
        }

        // Step 2: Fetch REAL stats from server ‚Äî quizzesCompleted increments on server every quiz
        if (!token) return;
        try {
            const response = await fetch(`${API_BASE}/api/user/complete-data`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) return;

            const data = await response.json();
            const u = data.user;

            // ‚úÖ This is the real quiz count - increases every time user completes a quiz
            document.getElementById('quizzesCompleted').textContent = u.quizzesCompleted || 0;

            // ‚úÖ Real server stats
            const serverBookmarks = data.bookmarkedCourses || localBookmarks;
            document.getElementById('savedCourses').textContent = serverBookmarks.length;
            document.getElementById('coursesExplored').textContent = u.coursesExplored || serverBookmarks.length;
            document.getElementById('learningHours').textContent = u.learningHours || (serverBookmarks.length * 2);

            // ‚úÖ Streak from server lastQuizDate (most accurate)
            const lastQuizDate = u.lastQuizDate || (localQuiz ? JSON.parse(localQuiz).completedAt : null);
            if (lastQuizDate) {
                document.getElementById('streakDays').textContent = getStreakText(lastQuizDate);
            } else {
                document.getElementById('streakDays').textContent = 'Take quiz today! üéØ';
            }

            // Update localStorage with fresh server data
            localStorage.setItem('sb_user', JSON.stringify(u));
            localStorage.setItem('skillupUser', JSON.stringify(u));
            if (Array.isArray(serverBookmarks)) {
                localStorage.setItem('bookmarkedCourses', JSON.stringify(serverBookmarks));
            }

        } catch (error) {
            console.error('Error fetching server stats:', error);
            // Local values already shown above ‚Äî no action needed
        }
    }

    function getStreakText(timestamp) {
        const daysSince = Math.floor((Date.now() - new Date(timestamp)) / (1000 * 60 * 60 * 24));
        if (daysSince === 0) return 'Today! üî•';
        if (daysSince === 1) return 'Yesterday';
        if (daysSince < 7) return `${daysSince} days ago`;
        if (daysSince < 30) return `${Math.floor(daysSince / 7)} weeks ago`;
        return `${Math.floor(daysSince / 30)} months ago`;
    }

    function loadQuizResults() {
        const quizData = localStorage.getItem('skillsQuizResults');
        
        if (quizData) {
            const { summary, completedAt, answers } = JSON.parse(quizData);
            
            if (summary) {
                // Update quiz summary display
                document.getElementById('quizSkillLevel').textContent = 
                    `${summary.skillLevel.charAt(0).toUpperCase() + summary.skillLevel.slice(1)} Level`;
                
                const interestsCount = summary.interests?.length || 0;
                document.getElementById('quizInterests').textContent = 
                    `${interestsCount} Interest${interestsCount !== 1 ? 's' : ''}`;
                
                if (completedAt) {
                    const date = new Date(completedAt);
                    document.getElementById('quizCompletedDate').textContent = 
                        `Completed on ${formatDate(date)}`;
                }

                // FIX: Real progress based on actual bookmarked courses per topic
                if (summary.interests && summary.interests.length > 0) {
                    // Fetch bookmarked courses with their topics
                    const bookmarkedIds = JSON.parse(localStorage.getItem('bookmarkedCourses') || '[]');
                    
                    // We need to fetch courses to get their topics
                    fetchCoursesForProgress(summary.interests, bookmarkedIds);
                } else {
                    document.getElementById('learningProgressContainer').innerHTML = 
                        '<p class="text-sm text-text-secondary text-center py-4">Complete the quiz to see your learning progress</p>';
                }

                // Update quiz summary card with detailed info
                const summaryCard = document.getElementById('quizResultsContainer');
                summaryCard.innerHTML = `
                    <div class="card p-6 hover:shadow-xl transition-all duration-300">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-3">
                                    <div class="w-10 h-10 bg-accent rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                        </svg>
                                    </div>
                                    <h3 class="font-medium text-lg text-text-primary">Skills Assessment Completed</h3>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="bg-primary-50 p-3 rounded-lg">
                                        <div class="text-xs text-text-secondary mb-1">Skill Level</div>
                                        <div class="font-semibold text-primary">${summary.skillLevel.charAt(0).toUpperCase() + summary.skillLevel.slice(1)}</div>
                                    </div>
                                    <div class="bg-secondary-50 p-3 rounded-lg">
                                        <div class="text-xs text-text-secondary mb-1">Learning Goal</div>
                                        <div class="font-semibold text-secondary">${formatGoal(answers[2])}</div>
                                    </div>
                                    <div class="bg-accent-50 p-3 rounded-lg">
                                        <div class="text-xs text-text-secondary mb-1">Time Commitment</div>
                                        <div class="font-semibold text-accent">${formatTime(answers[5])}</div>
                                    </div>
                                    <div class="bg-warning-50 p-3 rounded-lg">
                                        <div class="text-xs text-text-secondary mb-1">Budget Preference</div>
                                        <div class="font-semibold text-warning">${formatBudget(answers[6])}</div>
                                    </div>
                                </div>

                                <div class="bg-gray-50 p-3 rounded-lg mb-3">
                                    <div class="text-xs text-text-secondary mb-2">Your Interests</div>
                                    <div class="flex flex-wrap gap-2">
                                        ${summary.interests.map(interest => `
                                            <span class="text-xs bg-white px-3 py-1 rounded-full border border-border text-text-primary font-medium">
                                                ${formatInterestName(interest)}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>

                                <p class="text-sm text-text-secondary mb-3">
                                    <strong>üìÖ Completed:</strong> ${formatDate(new Date(completedAt))}
                                    ${answers[5] ? ` ‚Ä¢ <strong>‚è±Ô∏è Duration:</strong> ${Math.floor((JSON.parse(quizData).duration || 0) / 60000)} minutes` : ''}
                                </p>
                            </div>
                            <div class="flex flex-col space-y-2 ml-4">
                                <a href="course_recommendations_dashboard.html" class="btn btn-primary text-sm px-4 py-2 whitespace-nowrap">
                                    View Courses
                                </a>
                                <a href="interactive_skills_quiz.html" class="btn btn-secondary text-sm px-4 py-2 whitespace-nowrap">
                                    Retake Quiz
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            }
        } else {
            // No quiz completed
            document.getElementById('learningProgressContainer').innerHTML = 
                '<p class="text-sm text-text-secondary text-center py-4">Complete the quiz to see your progress</p>';
            
            document.getElementById('quizResultsContainer').innerHTML = `
                <div class="card p-6 bg-gradient-to-r from-primary-50 to-secondary-50 border-2 border-dashed border-primary-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-text-primary mb-1">Take Your Skills Assessment</h3>
                                <p class="text-text-secondary">Get personalized course recommendations based on your skills and goals</p>
                            </div>
                        </div>
                        <a href="interactive_skills_quiz.html" class="btn btn-primary whitespace-nowrap">
                            Start Quiz ‚Üí
                        </a>
                    </div>
                </div>
            `;
        }
    }

    // FIX: New function to calculate real progress based on bookmarked courses
    async function fetchCoursesForProgress(interests, bookmarkedIds) {
        try {
            // Fetch all courses to get their topics
            const [freeRes, paidRes] = await Promise.all([
                fetch(`${API_BASE}/api/courses?type=free&limit=100`),
                fetch(`${API_BASE}/api/courses?type=paid&limit=100`)
            ]);

            if (!freeRes.ok || !paidRes.ok) {
                throw new Error('Failed to fetch courses');
            }

            const freeData = await freeRes.json();
            const paidData = await paidRes.json();
            const allCourses = [...(freeData.courses || []), ...(paidData.courses || [])];

            // Get bookmarked courses with their topics
            const bookmarkedCourses = allCourses.filter(c => {
                const courseIdStr = String(c._id?.$oid || c._id);
                return bookmarkedIds.includes(courseIdStr);
            });

            // Map interests to course topics
            const interestTopicMap = {
                'web-dev': 'programming',
                'mobile-dev': 'programming',
                'data-science': 'programming',
                'design': 'design',
                'devops': 'programming',
                'cybersecurity': 'programming',
                'programming': 'programming',
                'business': 'business',
                'marketing': 'marketing'
            };

            const progressHTML = interests.slice(0, 3).map((interest, index) => {
                // Get the course topic for this interest
                const courseTopic = interestTopicMap[interest] || interest;
                
                // FIX: Real progress - count actual bookmarked courses in this topic
                const topicCourses = bookmarkedCourses.filter(c => c.topic === courseTopic);
                const topicCount = topicCourses.length;
                
                // Calculate real progress: 25% per course, max 100%
                const progress = Math.min(100, topicCount * 25);
                
                const colors = ['primary', 'secondary', 'accent'];
                const color = colors[index] || 'primary';
                
                console.log(`üìä ${formatInterestName(interest)}: ${topicCount} courses = ${progress}% progress`);
                
                return `
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-text-primary">${formatInterestName(interest)}</span>
                            <span class="text-sm text-text-secondary">${progress}% (${topicCount} course${topicCount !== 1 ? 's' : ''})</span>
                        </div>
                        <div class="w-full bg-border rounded-full h-2">
                            <div class="bg-${color} h-2 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('learningProgressContainer').innerHTML = progressHTML;

        } catch (error) {
            console.error('Error fetching courses for progress:', error);
            document.getElementById('learningProgressContainer').innerHTML = 
                '<p class="text-sm text-text-secondary text-center py-4">Unable to load progress data</p>';
        }
    }

    async function loadBookmarkedCourses() {
        const bookmarkedIds = JSON.parse(localStorage.getItem('bookmarkedCourses') || '[]');
        
        console.log('üìö Loading bookmarked courses...', bookmarkedIds);
        
        if (bookmarkedIds.length === 0) {
            console.log('‚ö†Ô∏è No bookmarks found');
            document.getElementById('bookmarkedCoursesLoading').classList.add('hidden');
            document.getElementById('noBookmarks').classList.remove('hidden');
            return;
        }

        try {
            console.log('üîÑ Fetching courses from API...');
            
            // Fetch all courses
            const [freeRes, paidRes] = await Promise.all([
                fetch(`${API_BASE}/api/courses?type=free&limit=100`),
                fetch(`${API_BASE}/api/courses?type=paid&limit=100`)
            ]);

            if (!freeRes.ok || !paidRes.ok) {
                throw new Error('Failed to fetch courses from server');
            }

            const freeData = await freeRes.json();
            const paidData = await paidRes.json();

            console.log('‚úÖ Fetched courses:', {
                free: freeData.courses?.length || 0,
                paid: paidData.courses?.length || 0
            });

            const allCourses = [...(freeData.courses || []), ...(paidData.courses || [])];
            
            // FIX: Handle MongoDB ObjectId format { "$oid": "..." }
            const bookmarkedCourses = allCourses.filter(c => {
                const courseIdStr = String(c._id?.$oid || c._id);
                const isBookmarked = bookmarkedIds.includes(courseIdStr);
                if (isBookmarked) {
                    console.log('‚úì Match found:', courseIdStr, '-', c.title);
                }
                return isBookmarked;
            }).slice(0, 4);

            console.log('üéØ Found bookmarked courses:', bookmarkedCourses.length);

            if (bookmarkedCourses.length > 0) {
                renderBookmarkedCourses(bookmarkedCourses);
            } else {
                console.warn('‚ö†Ô∏è Bookmarks exist but courses not found in database');
                document.getElementById('bookmarkedCoursesLoading').classList.add('hidden');
                document.getElementById('noBookmarks').innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-text-secondary mb-4">Your bookmarked courses are loading...</p>
                        <a href="course_recommendations_dashboard.html" class="btn btn-primary">Browse Courses</a>
                    </div>
                `;
                document.getElementById('noBookmarks').classList.remove('hidden');
            }

        } catch (error) {
            console.error('‚ùå Error loading bookmarked courses:', error);
            document.getElementById('bookmarkedCoursesLoading').classList.add('hidden');
            
            // Show error state with helpful message
            document.getElementById('noBookmarks').innerHTML = `
                <div class="text-center py-8">
                    <svg class="w-12 h-12 text-text-tertiary mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p class="text-text-secondary mb-4">Unable to load courses. Please check your connection.</p>
                    <button onclick="location.reload()" class="btn btn-primary">Retry</button>
                </div>
            `;
            document.getElementById('noBookmarks').classList.remove('hidden');
        }
    }

    function renderBookmarkedCourses(courses) {
        console.log('üé® Rendering', courses.length, 'courses');
        
        document.getElementById('bookmarkedCoursesLoading').classList.add('hidden');
        const container = document.getElementById('bookmarkedCoursesContainer');
        container.classList.remove('hidden');

        container.innerHTML = courses.map(course => {
            const topicColor = {
                'programming': 'primary',
                'design': 'secondary',
                'business': 'accent',
                'marketing': 'warning'
            }[course.topic] || 'primary';

            return `
                <div class="card overflow-hidden hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                    <div class="aspect-video overflow-hidden relative bg-gray-100">
                        <img src="${course.thumbnail || 'https://images.unsplash.com/photo-1516321318423-f06f85e504b3?q=80&w=400'}" 
                             alt="${course.title}" 
                             class="w-full h-full object-cover"
                             onerror="this.src='https://images.unsplash.com/photo-1516321318423-f06f85e504b3?q=80&w=400&auto=format&fit=crop'">
                        <div class="absolute top-2 right-2">
                            <span class="text-xs bg-${course.type === 'free' ? 'error' : 'accent'} text-white px-2 py-1 rounded font-semibold shadow-md">
                                ${course.type === 'free' ? 'FREE' : '‚Çπ' + course.price}
                            </span>
                        </div>
                        <div class="absolute top-2 left-2">
                            <span class="text-xs bg-black/70 text-white px-2 py-1 rounded backdrop-blur-sm">
                                ${course.difficulty || 'All Levels'}
                            </span>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs bg-${topicColor}-100 text-${topicColor} px-2 py-1 rounded font-medium capitalize">
                                ${course.topic || 'General'}
                            </span>
                            <svg class="w-5 h-5 text-error fill-current" viewBox="0 0 20 20">
                                <path d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/>
                            </svg>
                        </div>
                        <h3 class="font-semibold text-text-primary mb-2 line-clamp-2 min-h-[3rem] text-sm">
                            ${course.title}
                        </h3>
                        <p class="text-text-secondary text-xs mb-3 truncate">
                            ${course.provider || 'Unknown Provider'}
                        </p>
                        <div class="flex items-center justify-between border-t border-border pt-3">
                            <div class="flex items-center space-x-1">
                                <span class="text-yellow-400 text-sm">‚òÖ</span>
                                <span class="text-sm font-medium text-text-secondary">${course.rating || 'N/A'}</span>
                                ${course.students ? `<span class="text-xs text-text-tertiary">(${(course.students / 1000).toFixed(0)}k)</span>` : ''}
                            </div>
                            <span class="text-xs text-text-secondary">${course.duration || 'Self-paced'}</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        console.log('‚úÖ Courses rendered successfully');
    }

    function loadRecentActivity() {
        const activities = [];
        const user = JSON.parse(localStorage.getItem('sb_user') || '{}');
        
        // Account creation
        if (user.createdAt) {
            const date = new Date(user.createdAt);
            activities.push({
                icon: 'user',
                text: 'Created account',
                date: date,
                color: 'primary'
            });
        }

        // Quiz completion
        const quizData = localStorage.getItem('skillsQuizResults');
        if (quizData) {
            const quiz = JSON.parse(quizData);
            if (quiz.completedAt) {
                activities.push({
                    icon: 'check',
                    text: 'Completed Skills Assessment',
                    date: new Date(quiz.completedAt),
                    color: 'accent'
                });
            }
        }

        // Bookmarks
        const bookmarks = JSON.parse(localStorage.getItem('bookmarkedCourses') || '[]');
        if (bookmarks.length > 0) {
            activities.push({
                icon: 'heart',
                text: `Saved ${bookmarks.length} course${bookmarks.length !== 1 ? 's' : ''}`,
                date: new Date(),
                color: 'warning'
            });
        }

        // Sort by date (newest first)
        activities.sort((a, b) => b.date - a.date);

        // Render activities
        const container = document.getElementById('recentActivityContainer');
        if (activities.length > 0) {
            container.innerHTML = activities.slice(0, 5).map(activity => `
                <div class="flex items-start space-x-3 pb-4 border-b border-border last:border-0 last:pb-0">
                    <div class="w-8 h-8 bg-${activity.color}-50 rounded-full flex items-center justify-center flex-shrink-0">
                        ${getActivityIcon(activity.icon, activity.color)}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm text-text-primary font-medium">${activity.text}</p>
                        <p class="text-xs text-text-secondary">${formatRelativeDate(activity.date)}</p>
                    </div>
                </div>
            `).join('');
        }
    }

    function getActivityIcon(type, color) {
        const icons = {
            user: `<svg class="w-4 h-4 text-${color}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>`,
            check: `<svg class="w-4 h-4 text-${color}" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>`,
            heart: `<svg class="w-4 h-4 text-${color}" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"/></svg>`
        };
        return icons[type] || icons.user;
    }

    function formatDate(date) {
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function formatRelativeDate(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return 'Just now';
        if (minutes < 60) return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
        if (hours < 24) return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
        if (days < 7) return `${days} day${days !== 1 ? 's' : ''} ago`;
        return formatDate(date);
    }

    function formatInterestName(interest) {
        const names = {
            'web-dev': 'Web Development',
            'mobile-dev': 'Mobile Development',
            'data-science': 'Data Science',
            'design': 'UI/UX Design',
            'devops': 'DevOps',
            'cybersecurity': 'Cybersecurity',
            'programming': 'Programming',
            'business': 'Business',
            'marketing': 'Marketing'
        };
        return names[interest] || interest;
    }

    function formatGoal(goal) {
        const goals = {
            'career-change': 'Career Change',
            'skill-upgrade': 'Skill Upgrade',
            'side-project': 'Side Projects',
            'academic': 'Academic'
        };
        return goals[goal] || 'Not specified';
    }

    function formatTime(time) {
        const times = {
            '1-3-hours': '1-3 hrs/week',
            '4-7-hours': '4-7 hrs/week',
            '8-15-hours': '8-15 hrs/week',
            '15-plus': '15+ hrs/week'
        };
        return times[time] || 'Flexible';
    }

    function formatBudget(budget) {
        const budgets = {
            'free-only': 'Free Only',
            'under-500': 'Under ‚Çπ500',
            '500-2000': '‚Çπ500-2000',
            '2000-plus': '‚Çπ2000+'
        };
        return budgets[budget] || 'Any budget';
    }

    function handleLogout() {
    console.log("üîì Logging out...");

    // Remove all SkillUp Buddy session data
    localStorage.removeItem("sb_token");
    localStorage.removeItem("skillupToken");
    localStorage.removeItem("sb_user");
    localStorage.removeItem("skillupUser");
    localStorage.removeItem("skillsQuizResults");
    localStorage.removeItem("bookmarkedCourses");
    localStorage.removeItem("isLoggedIn");

    // Redirect to login page
    window.location.href = "user_login.html";
}

</script>

<script src="../js/userDataSync.js"></script>
</body>
</html>